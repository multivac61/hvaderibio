on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *" # Run every hour
name: Deploy
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    steps:
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - uses: actions/checkout@main

      - name: ğŸ“š Install node dependencies
        run: nix develop -c bun install

      - name: ğŸ”§ Rebuild sharp for Linux
        run: nix develop -c bun install sharp --force

      - name: ğŸ¬ Scrape movie data
        run: nix develop -c bun scrape

      - name: â˜‘ï¸ Check svelte-kit, format and linting
        run: nix develop -c bun check

      - name: ğŸ”¨ Build for Cloudflare
        run: nix develop -c bun run build
        env:
          ADAPTER: cloudflare
          NODE_ENV: production

      - name: ğŸš€ Deploy to Cloudflare Pages
        run: nix develop -c npx wrangler pages deploy .svelte-kit/cloudflare --project-name=hvaderibio --minify
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
